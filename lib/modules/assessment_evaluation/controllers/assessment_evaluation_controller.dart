import 'dart:async';
import 'package:fido_box_demo01/router/app_page.dart';
import 'package:get/get.dart';
import '../../voucher_purchase/domain/voucher_model.dart';
import '../../list_store/domain/store_model.dart';
import '../../list_store/controllers/list_store_controller.dart';
import '../domain/evaluate_result_model.dart';
import 'package:get_storage/get_storage.dart';
import '../../home_pickup_zone/controllers/home_pickup_zone_controller.dart';

// ‚úÖ i18n
import '../../../core/assets/locale_keys.g.dart';
import 'package:fido_box_demo01/core/extensions/string_extension.dart';

class AssessmentEvaluationController extends GetxController {
  late final EvaluateResultModel result;
  Timer? _countdownTimer;
  final RxString remainingTime = '24:00:00'.obs;
  DateTime? evaluationTime;
  final Rxn<VoucherModel> selectedVoucher = Rxn<VoucherModel>();
  final Rxn<StoreModel> selectedStore = Rxn<StoreModel>();

  // AtHome tab - date time selection
  final RxnString selectedDateTime = RxnString();
  final RxnString selectedDate = RxnString();
  final RxInt selectedDateIndex = 0.obs;

  // Store tab - date time selection (ri√™ng bi·ªát v·ªõi AtHome)
  final Rxn<DateTime> selectedCustomDate = Rxn<DateTime>();
  final RxnString selectedCustomTimeSlot = RxnString();
  final RxnString selectedStoreDateTime = RxnString(); // DateTime ri√™ng cho Store tab

  // Store tab - phone number (ri√™ng bi·ªát v·ªõi AtHome)
  final RxnString storePhoneNumber = RxnString();
  final RxnString storeContactName = RxnString();

  // Store tab - validation states
  final RxBool isStoreContactNameValid = true.obs;
  final RxBool isStorePhoneNumberValid = true.obs;
  final RxnString storeContactNameError = RxnString();
  final RxnString storePhoneNumberError = RxnString();

  // Th√™m c√°c bi·∫øn l∆∞u tr·ªØ th√¥ng tin booking
  final RxnString savedContactName = RxnString();
  final RxnString savedPhoneNumber = RxnString();
  final RxnString savedAddress = RxnString();
  final RxnString savedDateTime = RxnString();
  final RxBool hasBookingHistory = false.obs;

  // Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn ƒë√£ ch·ªçn (0: C·ª≠a h√†ng, 1: T·∫°i nh√†, 2: G·ª≠i h√†ng)
  final RxInt selectedPickupMethod = (-1).obs; // -1 = ch∆∞a ch·ªçn

  void selectDate(String date) {
    selectedDate.value = date;
  }

  void selectDateTime(String dateTime) {
    selectedDateTime.value = dateTime;
    print('üè† AtHome tab - selectedDateTime: $dateTime');
    print('üè† AtHome tab - selectedStoreDateTime: ${selectedStoreDateTime.value}');
    print('üè† AtHome tab - selectedCustomTimeSlot: ${selectedCustomTimeSlot.value}');
    print('---');
  }

  void clearSelectedDateTime() {
    selectedDateTime.value = null;
  }

  void clearStoreDateTime() {
    selectedCustomDate.value = null;
    selectedCustomTimeSlot.value = null;
    selectedStoreDateTime.value = null;
  }

  void updateStorePhoneNumber(String phoneNumber) {
    storePhoneNumber.value = phoneNumber;
    _validateStorePhoneNumber(phoneNumber);
    print('üè™ Store tab - updateStorePhoneNumber: $phoneNumber');
  }

  void updateStoreContactName(String contactName) {
    storeContactName.value = contactName;
    _validateStoreContactName(contactName);
    print('üè™ Store tab - updateStoreContactName: $contactName');
  }

  /// Validate t√™n li√™n h·ªá real-time
  void _validateStoreContactName(String contactName) {
    final trimmed = contactName.trim();
    if (trimmed.isEmpty) {
      isStoreContactNameValid.value = false;
      // i18n
      storeContactNameError.value = LocaleKeys.store_contact_name_empty.trans();
    } else {
      isStoreContactNameValid.value = true;
      storeContactNameError.value = null;
    }
  }

  /// Validate s·ªë ƒëi·ªán tho·∫°i real-time
  void _validateStorePhoneNumber(String phoneNumber) {
    final trimmed = phoneNumber.trim();
    if (trimmed.isEmpty) {
      isStorePhoneNumberValid.value = false;
      // i18n
      storePhoneNumberError.value = LocaleKeys.store_phone_empty.trans();
    } else {
      // Ki·ªÉm tra format s·ªë ƒëi·ªán tho·∫°i
      final RegExp phoneRegex = RegExp(r'^(0|\+84)[3|5|7|8|9][0-9]{8}$');
      final cleanNumber = trimmed.replaceAll(' ', '').replaceAll('-', '');
      if (!phoneRegex.hasMatch(cleanNumber)) {
        isStorePhoneNumberValid.value = false;
        // i18n
        storePhoneNumberError.value = LocaleKeys.store_phone_invalid.trans();
      } else {
        isStorePhoneNumberValid.value = true;
        storePhoneNumberError.value = null;
      }
    }
  }

  /// Ki·ªÉm tra th√¥ng tin Store tab c√≥ h·ª£p l·ªá kh√¥ng
  bool isStoreInfoValid() {
    final phoneNumber = storePhoneNumber.value?.trim() ?? '';
    final contactName = storeContactName.value?.trim() ?? '';

    if (contactName.isEmpty) {
      print('‚ùå ${LocaleKeys.store_contact_name_empty.trans()}');
      return false;
    }

    if (phoneNumber.isEmpty) {
      print('‚ùå ${LocaleKeys.store_phone_empty.trans()}');
      return false;
    }

    // Ki·ªÉm tra format s·ªë ƒëi·ªán tho·∫°i
    final RegExp phoneRegex = RegExp(r'^(0|\+84)[3|5|7|8|9][0-9]{8}$');
    final cleanNumber = phoneNumber.replaceAll(' ', '').replaceAll('-', '');
    if (!phoneRegex.hasMatch(cleanNumber)) {
      print('‚ùå ${LocaleKeys.store_phone_invalid.trans()}');
      return false;
    }

    return true;
  }

  /// Trigger validation ƒë·ªÉ hi·ªÉn th·ªã error messages khi nh·∫•n n√∫t x√°c nh·∫≠n
  void validateStoreFields() {
    // Validate t√™n li√™n h·ªá
    final contactName = storeContactName.value?.trim() ?? '';
    _validateStoreContactName(contactName);

    // Validate s·ªë ƒëi·ªán tho·∫°i
    final phoneNumber = storePhoneNumber.value?.trim() ?? '';
    _validateStorePhoneNumber(phoneNumber);
  }

  void selectCustomDate(DateTime date) {
    selectedCustomDate.value = date;
    print('üè™ Store tab - selectCustomDate: $date');
    print('üè™ Store tab - selectedDateTime: ${selectedDateTime.value}');
    // C·∫≠p nh·∫≠t selectedStoreDateTime ri√™ng cho Store tab
    _updateStoreDateTime();
  }

  void selectCustomTimeSlot(String timeSlot) {
    selectedCustomTimeSlot.value = timeSlot;
    print('üè™ Store tab - selectCustomTimeSlot: $timeSlot');
    print('üè™ Store tab - selectedDateTime: ${selectedDateTime.value}');
    // C·∫≠p nh·∫≠t selectedStoreDateTime ri√™ng cho Store tab
    _updateStoreDateTime();
  }

  // Ph∆∞∆°ng th·ª©c ƒë·ªÉ set ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn
  void setPickupMethod(int methodIndex) {
    selectedPickupMethod.value = methodIndex;
  }

  // Ki·ªÉm tra xem ƒë√£ ch·ªçn ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn ch∆∞a
  bool get hasSelectedPickupMethod => selectedPickupMethod.value >= 0;

  // L·∫•y t√™n ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn
  String get pickupMethodName {
    switch (selectedPickupMethod.value) {
      case 0:
        return LocaleKeys.pickup_store.trans();
      case 1:
        return LocaleKeys.pickup_home.trans();
      case 2:
        return LocaleKeys.pickup_ship.trans();
      default:
        return LocaleKeys.pickup_not_selected.trans();
    }
  }

  void selectDateIndex(int index) {
    selectedDateIndex.value = index;
  }

  void saveSelectedDateTime() {
    if (selectedDateTime.value != null) {
      print('Saved selected date time: ${selectedDateTime.value}');
    }
  }

  @override
  void onInit() {
    super.onInit();
    result = Get.arguments as EvaluateResultModel;
    evaluationTime = DateTime.now();
    startCountdown();
    // Load th√¥ng tin booking ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥
    loadBookingHistory();
  }

  void selectStore(StoreModel store) {
    selectedStore.value = store;
    print('AssessmentEvaluationController: Selected store ${store.name}');
  }

  void clearSelectedStore() {
    selectedStore.value = null;
  }

  /// L·∫•y c·ª≠a h√†ng hi·ªán t·∫°i (ƒë√£ ch·ªçn ho·∫∑c g·∫ßn nh·∫•t)
  StoreModel? getCurrentStore() {
    // N·∫øu ƒë√£ ch·ªçn c·ª≠a h√†ng, tr·∫£ v·ªÅ c·ª≠a h√†ng ƒë√£ ch·ªçn
    if (selectedStore.value != null) {
      return selectedStore.value;
    }

    // N·∫øu ch∆∞a ch·ªçn, l·∫•y c·ª≠a h√†ng g·∫ßn nh·∫•t t·ª´ ListStoreController
    try {
      if (Get.isRegistered<ListStoreController>()) {
        final storeController = Get.find<ListStoreController>();
        if (storeController.filteredStores.isNotEmpty) {
          return storeController.filteredStores.first; // C·ª≠a h√†ng g·∫ßn nh·∫•t
        }
      }
    } catch (e) {
      print('Error getting nearest store: $e');
    }

    return null;
  }

  /// Auto-select c·ª≠a h√†ng g·∫ßn nh·∫•t n·∫øu ch∆∞a ch·ªçn
  void autoSelectNearestStore() {
    if (selectedStore.value == null) {
      final nearestStore = getCurrentStore();
      if (nearestStore != null) {
        selectedStore.value = nearestStore;
        print('Auto-selected nearest store: ${nearestStore.name}');
      }
    }
  }

  void startCountdown() {
    _countdownTimer?.cancel();
    _countdownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (evaluationTime != null) {
        final elapsed = DateTime.now().difference(evaluationTime!);
        final remaining = const Duration(hours: 24) - elapsed;

        if (remaining.isNegative) {
          // i18n
          remainingTime.value = LocaleKeys.expired.trans();
          timer.cancel();
        } else {
          remainingTime.value = _formatDuration(remaining);
        }
      }
    });
  }

  String _formatDuration(Duration duration) {
    final hours = duration.inHours;
    final minutes = duration.inMinutes % 60;
    final seconds = duration.inSeconds % 60;
    return "${hours.toString().padLeft(2, '0')}:${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}";
  }

  void selectVoucher() async {
    final result = await Get.toNamed(Routes.walletVoucher);
    if (result is VoucherModel) {
      selectedVoucher.value = result;
    }
  }

  String getRemainingTime() => remainingTime.value;

  @override
  void onClose() {
    _countdownTimer?.cancel();
    super.onClose();
  }

  // Th√™m method ƒë·ªÉ l∆∞u th√¥ng tin booking
  void saveBookingInfo({
    required String contactName,
    required String phoneNumber,
    required String address,
    required String dateTime,
  }) {
    savedContactName.value = contactName;
    savedPhoneNumber.value = phoneNumber;
    savedAddress.value = address;
    savedDateTime.value = dateTime;
    hasBookingHistory.value = true;

    // L∆∞u v√†o storage ƒë·ªÉ persistent
    final storage = GetStorage();
    storage.write('booking_contact', contactName);
    storage.write('booking_phone', phoneNumber);
    storage.write('booking_address', address);
    storage.write('booking_datetime', dateTime);
    storage.write('has_booking_history', true);
  }

  // Load th√¥ng tin ƒë√£ l∆∞u
  void loadBookingHistory() {
    final storage = GetStorage();
    savedContactName.value = storage.read('booking_contact');
    savedPhoneNumber.value = storage.read('booking_phone');
    savedAddress.value = storage.read('booking_address');
    savedDateTime.value = storage.read('booking_datetime');
    hasBookingHistory.value = storage.read('has_booking_history') ?? false;

    // N·∫øu ch∆∞a c√≥ th√¥ng tin, t·ª± ƒë·ªông load ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
    if (!hasBookingHistory.value ||
        (savedAddress.value?.isEmpty ?? true) ||
        (savedContactName.value?.isEmpty ?? true)) {
      _loadDefaultAddressIfNeeded();
    }
  }

  // T·ª± ƒë·ªông load ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh n·∫øu c·∫ßn
  void _loadDefaultAddressIfNeeded() {
    try {
      final homePickupController = Get.find<HomePickupZoneController>();

      // ∆Øu ti√™n l·∫•y ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh tr∆∞·ªõc
      var defaultAddress = homePickupController.getDefaultAddress();

      // N·∫øu kh√¥ng c√≥ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh, l·∫•y ƒë·ªãa ch·ªâ ƒë·∫ßu ti√™n trong danh s√°ch
      if (defaultAddress == null &&
          homePickupController.savedBookingList.isNotEmpty) {
        defaultAddress = homePickupController.savedBookingList.first;
        print('No default address found, using first address in list');
      }

      if (defaultAddress != null) {
        print('Auto-loading address: ${defaultAddress['fullAddress']}');

        // Set ƒë·ªãa ch·ªâ v√†o controller
        savedAddress.value = defaultAddress['fullAddress'] ?? '';
        savedContactName.value = defaultAddress['contactName'] ?? '';
        savedPhoneNumber.value = defaultAddress['phoneNumber'] ?? '';
        hasBookingHistory.value = true;

        // L∆∞u v√†o storage ƒë·ªÉ persistent
        saveBookingInfo(
          contactName: defaultAddress['contactName'] ?? '',
          phoneNumber: defaultAddress['phoneNumber'] ?? '',
          address: defaultAddress['fullAddress'] ?? '',
          dateTime: '', // ƒê·ªÉ tr·ªëng v√¨ ch∆∞a ch·ªçn th·ªùi gian
        );

        print('Default address auto-loaded successfully');
      } else {
        print('No addresses found to auto-load');
      }
    } catch (e) {
      print('Error auto-loading default address: $e');
      // HomePickupZoneController ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o ho·∫∑c c√≥ l·ªói
    }
  }

  /// Public method ƒë·ªÉ auto-load ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh (ƒë∆∞·ª£c g·ªçi t·ª´ UI)
  void autoLoadDefaultAddress() {
    _loadDefaultAddressIfNeeded();
  }

  /// C·∫≠p nh·∫≠t selectedStoreDateTime t·ª´ custom date v√† time slot (ri√™ng cho Store tab)
  void _updateStoreDateTime() {
    if (selectedCustomDate.value != null && selectedCustomTimeSlot.value != null) {
      final date = selectedCustomDate.value!;
      final formattedDate = '${date.day.toString().padLeft(2, '0')}/'
          '${date.month.toString().padLeft(2, '0')}/'
          '${date.year}';
      final newDateTime = '$formattedDate ${selectedCustomTimeSlot.value}';

      // C·∫≠p nh·∫≠t selectedStoreDateTime ri√™ng cho Store tab
      selectedStoreDateTime.value = newDateTime;

      print('üè™ Store tab - _updateStoreDateTime: $newDateTime');
      print('üè™ Store tab - selectedDateTime v·∫´n l√†: ${selectedDateTime.value}');
      print('---');
    }
  }

  /// Reset tr·∫°ng th√°i ƒë·ªÉ ƒë√°nh gi√° l·∫°i s·∫£n ph·∫©m
  void resetEvaluationState() {
    // Reset voucher ƒë√£ ch·ªçn
    selectedVoucher.value = null;

    // Reset pickup method v·ªÅ -1 (ch∆∞a ch·ªçn)
    selectedPickupMethod.value = -1;

    print('üîÑ Reset pickup method, keep other info unchanged');
  }
}
